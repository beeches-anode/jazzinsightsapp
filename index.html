<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insights from the Jazz Intensive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'parchment': '#F9F6F2',
                        'brand-tan': '#EAE4DC',
                        'brand-dark': '#333333',
                    },
                    fontFamily: {
                        'serif': ['Lora', 'serif'],
                        'sans': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #F9F6F2;
        }
        .filter-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- NEW: Note Editor Modal Component ---
        const NoteEditor = ({ initialNote, onSave, onDelete, onClose }) => {
          const [text, setText] = React.useState(initialNote);
          const textAreaRef = React.useRef(null);

          React.useEffect(() => {
            // Auto-focus the textarea when the editor opens
            textAreaRef.current?.focus();
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
            return () => {
              document.body.style.overflow = 'auto';
            };
          }, []);

          const handleSave = () => {
            onSave(text);
          };

          const handleDelete = () => {
            // Add a confirmation before deleting
            if (window.confirm("Are you sure you want to delete this note?")) {
              onDelete();
            }
          };

          return (
            <div 
              className="fixed inset-0 bg-black/60 z-40 flex items-center justify-center p-4" 
              onClick={onClose}
            >
              <div 
                className="bg-white rounded-lg shadow-2xl max-w-lg w-full p-6 flex flex-col gap-4" 
                onClick={e => e.stopPropagation()}
              >
                <h3 className="text-xl font-serif font-bold text-brand-dark">My Note</h3>
                <textarea
                  ref={textAreaRef}
                  value={text}
                  onChange={e => setText(e.target.value)}
                  className="w-full h-48 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-brand-dark"
                  placeholder="Type your personal note here..."
                />
                <div className="flex justify-between items-center">
                  <button
                    onClick={handleDelete}
                    className="text-sm text-red-600 hover:underline disabled:opacity-50"
                    disabled={!initialNote}
                  >
                    Delete Note
                  </button>
                  <div className="flex gap-3">
                    <button
                      onClick={onClose}
                      className="px-4 py-2 text-sm font-semibold rounded-full border border-gray-300 hover:bg-brand-tan"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleSave}
                      className="px-6 py-2 text-sm font-semibold rounded-full bg-brand-dark text-white hover:bg-opacity-80"
                    >
                      Save Note
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        };
        
        // --- NEW: Welcome Modal Component ---
        const WelcomeModal = ({ onLoadData, onStartFresh }) => {
          return (
            <div className="fixed inset-0 bg-parchment z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-lg shadow-2xl max-w-lg w-full p-8 text-center border border-gray-200">
                <h2 className="text-3xl font-serif font-bold text-brand-dark mb-4">Welcome!</h2>
                <p className="text-gray-600 mb-8">
                  You can import a previously saved data file to restore your notes and statuses, or start fresh.
                </p>
                <div className="flex flex-col sm:flex-row justify-center gap-4">
                  <button
                    onClick={onLoadData}
                    className="bg-brand-dark text-white font-semibold py-3 px-6 rounded-full hover:bg-opacity-80 transition-colors order-1 sm:order-2"
                  >
                    Load Saved Data
                  </button>
                  <button
                    onClick={onStartFresh}
                    className="bg-white text-brand-dark font-semibold py-3 px-6 border border-stone-300 rounded-full hover:bg-brand-tan transition-colors order-2 sm:order-1"
                  >
                    Start Fresh
                  </button>
                </div>
              </div>
            </div>
          );
        };
        

        // --- CONSTANTS ---
        // We'll define the number of items to show per page as a constant
        const ITEMS_PER_PAGE = 20;
        
        const TAGS_TO_SHOW = 12;

        const InsightCard = ({ insight, onToggleFav, onToggleReviewed, onSaveNote, onDeleteNote }) => {
          // This state is local to the card and just controls the modal visibility
          const [isEditingNote, setIsEditingNote] = React.useState(false);
          
          const parseMarkdown = (text) => {
            if(!text) return { __html: '' };
            // Added whitespace-pre-wrap to respect line breaks in notes
            let html = text
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
              .replace(/\*(.*?)\*/g, '<em>$1</em>')      
              .replace(/`(.*?)`/g, '<code class="bg-gray-200 text-gray-800 px-1 rounded-sm">$1</code>')     
              .replace(/\n/g, '<br />');
            return { __html: html };
          };

          const handleSave = (noteText) => {
            onSaveNote(insight.id, noteText);
            setIsEditingNote(false);
          };
          
          const handleDelete = () => {
            onDeleteNote(insight.id);
            setIsEditingNote(false);
          };

          return (
            <>
              {/* --- NEW: Note Editor is rendered here when active --- */}
              {isEditingNote && (
                <NoteEditor 
                  initialNote={insight.note}
                  onSave={handleSave}
                  onDelete={handleDelete}
                  onClose={() => setIsEditingNote(false)}
                />
              )}

              <div className="bg-white border border-gray-200/80 rounded-lg shadow-sm hover:shadow-lg hover:shadow-gray-200/80 transition-shadow duration-300 ease-in-out overflow-hidden flex flex-col">
                <div className="p-6 flex-grow">
                  <div className="mb-4">
                    <h2 className="text-2xl font-serif font-bold text-brand-dark mb-3">
                      {insight.title}
                    </h2>
                  
                    <div className="flex items-center gap-3 flex-wrap">
                      <span className="text-xs font-semibold text-gray-600 bg-gray-100 px-2.5 py-1 rounded-full">
                        {insight.call_date}
                      </span>
                  
                      <button
                        aria-pressed={insight.fav}
                        onClick={onToggleFav}
                        className={`px-3 py-1 rounded-full text-xs font-semibold border transition
                          ${insight.fav
                            ? 'bg-yellow-400/80 text-brand-dark border-yellow-600'
                            : 'bg-white text-gray-700 hover:bg-brand-tan border-gray-300'}`}
                      >
                        {insight.fav ? '‚òÖ Favourite' : '‚òÜ Favourite'}
                      </button>
                  
                      <button
                        aria-pressed={insight.reviewed}
                        onClick={onToggleReviewed}
                        className={`px-3 py-1 rounded-full text-xs font-semibold border transition
                          ${insight.reviewed
                            ? 'bg-green-400/70 text-brand-dark border-green-600'
                            : 'bg-white text-gray-700 hover:bg-brand-tan border-gray-300'}`}
                      >
                        {insight.reviewed ? '‚úì Reviewed' : 'Mark Reviewed'}
                      </button>

                      {/* --- NEW: Add/Edit Note Button --- */}
                      <button
                        onClick={() => setIsEditingNote(true)}
                        className={`px-3 py-1 rounded-full text-xs font-semibold border transition
                          ${insight.note
                            ? 'bg-blue-400/70 text-brand-dark border-blue-600'
                            : 'bg-white text-gray-700 hover:bg-brand-tan border-gray-300'}`}
                      >
                       {insight.note ? 'üìù Edit Note' : 'üìù Add Note'}
                      </button>

                    </div>
                  </div>

                  { insight.coach && <p className="text-sm font-semibold text-gray-500 mb-4">Coach: {insight.coach}</p> }
                  
                  <div className="mb-5 flex flex-wrap gap-2">
                      {insight.tags && insight.tags.map(tag => (
                        <span key={tag} className="inline-flex items-center bg-brand-tan text-brand-dark text-xs font-semibold px-3 py-1 rounded-full">
                          {tag.replace(/_/g, ' ')}
                        </span>
                      ))}
                  </div>

                  <div className="space-y-5 text-gray-700 leading-relaxed">
                    {insight.context && (
                      <div>
                          <h3 className="font-sans font-bold text-brand-dark mb-1 text-sm uppercase tracking-wider">Context</h3>
                          <p className="text-sm" dangerouslySetInnerHTML={parseMarkdown(insight.context)}></p>
                      </div>
                    )}
                    {insight.instruction && (
                      <div>
                          <h3 className="font-sans font-bold text-brand-dark mb-1 text-sm uppercase tracking-wider">Instruction</h3>
                          <p className="text-sm" dangerouslySetInnerHTML={parseMarkdown(insight.instruction)}></p>
                      </div>
                    )}
                  </div>

                  {insight.quote && (
                    <blockquote className="mt-6 p-4 bg-brand-tan/50 border-l-4 border-brand-dark/50 rounded-r-lg relative">
                      <p className="text-lg absolute -top-3 -left-1 text-brand-dark/30 font-serif">‚Äú</p>
                      <p className="text-sm italic text-brand-dark" dangerouslySetInnerHTML={parseMarkdown(insight.quote)}></p>
                    </blockquote>
                  )}
                  
                  {/* --- NEW: Display for the saved note --- */}
                  {insight.note && (
                    <div className="mt-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                        <h4 className="font-sans font-bold text-brand-dark mb-1 text-sm uppercase tracking-wider">My Note</h4>
                        <p className="text-sm text-gray-800 whitespace-pre-wrap">{insight.note}</p>
                    </div>
                  )}

                </div>
                
                {insight.youtube_timestamp &&
                  <div className="bg-gray-50 px-6 py-3 border-t border-gray-200/80">
                      <a href={insight.youtube_timestamp} target="_blank" rel="noopener noreferrer" className="inline-flex items-center text-sm font-semibold text-gray-600 hover:text-brand-dark transition-colors">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-5 h-5 mr-2"><path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17"></path><path d="m10 15 5-3-5-3z"></path></svg>
                      Watch on YouTube
                      </a>
                  </div>
                }
              </div>
            </>
          );
        };        
        
        // --- STICKY HEADER COMPONENT (NEW) ---
        const StickyHeader = ({ isSticky, onShowFilters, visibleCount, totalCount }) => {
          if (!isSticky) {
            return null;
          }

          return (
            <div className="fixed top-0 left-0 right-0 z-20 bg-parchment/95 backdrop-blur-sm shadow-md transition-transform duration-300 ease-in-out transform translate-y-0">
              <div className="container mx-auto px-4">
                <div className="flex items-center justify-between h-16">
                  <h2 className="text-xl font-serif font-bold text-brand-dark">
                    Insights from the Jazz Intensive
                  </h2>
                  <div className="flex items-center gap-4">
                    <span className="text-sm text-gray-600 font-semibold hidden sm:block">
                      {`Displaying ${visibleCount} of ${totalCount}`}
                    </span>
                    <button
                      onClick={onShowFilters}
                      className="bg-white text-brand-dark font-semibold py-2 px-4 border border-stone-300 rounded-full hover:bg-brand-tan transition-colors"
                    >
                      Filter & Search
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const FilterControls = ({
          searchTerm, onSearchTermChange,
          sortOrder, onSortOrderChange,
          coaches, selectedCoaches, onSelectCoach,
          years, selectedYear, onSelectYear,
          months, selectedMonth, onSelectMonth,
          days, selectedDay, onSelectDay,
          tags, selectedTags, onSelectTag,
          tagsExpanded, onToggleTags,
          favOnly, onToggleFav,
          reviewedOnly, onToggleReviewed,
          hasNoteOnly, onToggleHasNote, // New props for note filter
          hasActiveFilters, onClearAll
        }) => {
          return (
            <div className="space-y-4">
              <h3 className="text-xl font-bold font-serif text-brand-dark text-center">Filter & Search</h3>
              
              <div className="relative">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input
                  type="text"
                  placeholder="Search for insights, concepts, or quotes..."
                  value={searchTerm}
                  onChange={(e) => onSearchTermChange(e.target.value)}
                  className="w-full pl-12 pr-4 py-3 bg-white border border-gray-300 rounded-full shadow-sm focus:ring-2 focus:ring-brand-dark focus:border-brand-dark transition-all"
                />
              </div>
              
              <div>
                <h3 className="font-bold text-brand-dark text-center mb-2">Order By</h3>
                <select
                  value={sortOrder}
                  onChange={e => onSortOrderChange(e.target.value)}
                  className="filter-select w-full px-4 py-2 bg-white border border-gray-300 text-brand-dark rounded-md shadow-sm focus:ring-2 focus:ring-brand-dark focus:border-brand-dark"
                >
                  <option value="date-desc">Date (Newest First)</option>
                  <option value="date-asc">Date (Oldest First)</option>
                  <option value="alpha">Title (A-Z)</option>
                  <option value="random">Random</option>
                </select>
              </div>

              <div className="p-4 bg-brand-tan/60 rounded-lg border border-stone-300/70 space-y-4">
                <div>
                    <h3 className="font-bold text-brand-dark text-center mb-2">Filter by Coach</h3>
                    <div className="flex flex-wrap justify-center gap-2">
                        {coaches.map(coach => (
                            <button
                            key={coach}
                            onClick={() => onSelectCoach(coach)}
                            className={`px-4 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 ease-in-out border ${
                                selectedCoaches.includes(coach)
                                ? 'bg-brand-dark text-white border-brand-dark'
                                : 'bg-white text-gray-700 hover:bg-brand-tan hover:border-stone-300 border-gray-300'
                            }`}
                            >
                            {coach}
                            </button>
                        ))}
                    </div>
                </div>

                 <div>
                    <h3 className="font-bold text-brand-dark text-center mb-2">Filter by Date</h3>
                    <div className="flex gap-2">
                      <select
                        value={selectedYear}
                        onChange={e => onSelectYear(e.target.value)}
                        className="filter-select flex-1 px-4 py-2 bg-white border border-gray-300 text-brand-dark rounded-md shadow-sm focus:ring-2 focus:ring-brand-dark focus:border-brand-dark"
                      >
                        <option value="">All Years</option>
                        {years.map(year => <option key={year}>{year}</option>)}
                      </select>
                      <select
                        value={selectedMonth}
                        onChange={e => onSelectMonth(e.target.value)}
                        disabled={!selectedYear}
                        className="filter-select flex-1 px-4 py-2 bg-white border border-gray-300 text-brand-dark rounded-md shadow-sm focus:ring-2 focus:ring-brand-dark focus:border-brand-dark"
                      >
                        <option value="">All Months</option>
                        {months.map(month => <option key={month} value={month}>{month}</option>)}
                      </select>
                      <select
                        value={selectedDay}
                        onChange={e => onSelectDay(e.target.value)}
                        disabled={!selectedMonth}
                        className="filter-select flex-1 px-4 py-2 bg-white border border-gray-300 text-brand-dark rounded-md shadow-sm focus:ring-2 focus:ring-brand-dark focus:border-brand-dark"
                      >
                        <option value="">All Days</option>
                        {days.map(d => <option key={d}>{d}</option>)}
                      </select>
                    </div>
                </div>

                <div>
                  <h3 className="font-bold text-brand-dark text-center mb-2">Filter by Status</h3>
                  <div className="flex flex-wrap justify-center gap-3">
                    <button
                      onClick={onToggleFav}
                      className={`px-4 py-1.5 text-sm font-semibold rounded-full border transition ${
                        favOnly
                          ? 'bg-yellow-400/80 text-brand-dark border-yellow-600'
                          : 'bg-white text-gray-700 hover:bg-brand-tan hover:border-stone-300 border-gray-300'
                      }`}
                    >
                      ‚òÖ Favourite
                    </button>
                    <button
                      onClick={onToggleReviewed}
                      className={`px-4 py-1.5 text-sm font-semibold rounded-full border transition ${
                        reviewedOnly
                          ? 'bg-green-400/70 text-brand-dark border-green-600'
                          : 'bg-white text-gray-700 hover:bg-brand-tan hover:border-stone-300 border-gray-300'
                      }`}
                    >
                      ‚úì Reviewed
                    </button>
                    {/* --- NEW: "Has Note" Filter Button --- */}
                    <button
                      onClick={onToggleHasNote}
                      className={`px-4 py-1.5 text-sm font-semibold rounded-full border transition ${
                        hasNoteOnly
                          ? 'bg-blue-400/70 text-brand-dark border-blue-600'
                          : 'bg-white text-gray-700 hover:bg-brand-tan hover:border-stone-300 border-gray-300'
                      }`}
                    >
                      üìù Has Note
                    </button>
                  </div>
                </div>
                
                 <div>
                    <h3 className="font-bold text-brand-dark text-center mb-2">Filter by Tags</h3>
                    <div className="flex flex-wrap justify-center gap-2">
                        {(tagsExpanded ? tags : tags.slice(0, TAGS_TO_SHOW)).map(tag => (
                            <button
                            key={tag}
                            onClick={() => onSelectTag(tag)}
                            className={`px-3 py-1 text-xs sm:text-sm font-semibold rounded-full transition-all duration-200 ease-in-out border ${
                                selectedTags.includes(tag)
                                ? 'bg-brand-dark text-white border-brand-dark'
                                : 'bg-white text-gray-700 hover:bg-brand-tan hover:border-stone-300 border-gray-300'
                            }`}
                            >
                            {tag.replace(/_/g, ' ')}
                            </button>
                        ))}
                    </div>
                    {tags.length > TAGS_TO_SHOW && (
                        <div className="text-center mt-3">
                            <button onClick={onToggleTags} className="text-sm text-gray-600 hover:text-brand-dark font-semibold">
                                {tagsExpanded ? 'Show Less' : `Show ${tags.length - TAGS_TO_SHOW} More...`}
                            </button>
                        </div>
                    )}
                 </div>

                {hasActiveFilters && (
                    <div className="text-center pt-4 border-t border-stone-300/70">
                        <button onClick={onClearAll} className="text-sm text-gray-600 hover:text-brand-dark font-semibold underline">
                            Clear All Filters
                        </button>
                    </div>
                )}
              </div>
            </div>
          );
        };
       
        const FilterOverlay = ({ isVisible, onClose, children }) => {
          if (!isVisible) {
            return null;
          }

          return (
            <div className="fixed inset-0 bg-black/50 z-30 flex items-center justify-center p-4">
              <div className="bg-parchment rounded-lg shadow-2xl max-w-2xl w-full flex flex-col max-h-[90vh]">
                <div className="p-6 overflow-y-auto">
                  {children}
                </div>
                <div className="p-4 bg-brand-tan/60 border-t border-stone-300/70 text-right">
                  <button
                    onClick={onClose}
                    className="bg-brand-dark text-white font-semibold py-2 px-6 rounded-full hover:bg-opacity-80 transition-all"
                  >
                    Done
                  </button>
                </div>
              </div>
            </div>
          );
        };

const App = () => {
          const [insightsBase, setInsightsBase] = useState([]);
          const [insights, setInsights] = useState([]);

          const allTags = useMemo(() => {
            return Array.isArray(insightsBase)
              ? [...new Set(insightsBase.flatMap(insight => insight.tags || []))].sort()
              : [];
          }, [insightsBase]);

          const allCoaches = useMemo(() => {
            return Array.isArray(insightsBase)
              ? [...new Set(insightsBase.flatMap(insight => insight.coach ? [insight.coach] : []))].sort()
              : [];
          }, [insightsBase]);

          const [searchTerm, setSearchTerm] = useState('');
          const [selectedTags, setSelectedTags] = useState([]);
          const [selectedCoaches, setSelectedCoaches] = useState([]);
          const [tagsExpanded, setTagsExpanded] = useState(false);
          const [selectedYear, setSelectedYear] = useState('');
          const [selectedMonth, setSelectedMonth] = useState('');
          const [selectedDay, setSelectedDay] = useState('');
          const [favOnly, setFavOnly] = useState(false);
          const [reviewedOnly, setReviewedOnly] = useState(false);
          const [hasNoteOnly, setHasNoteOnly] = useState(false);
          const [sortOrder, setSortOrder] = useState('date-desc');
          const [visibleCount, setVisibleCount] = useState(ITEMS_PER_PAGE);
          const [isSticky, setIsSticky] = useState(false);
          
        const DB_NAME = 'JazzInsightsDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'insights';
        
        function openDatabase() {
          return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => reject(event.target.error);
            request.onsuccess = (event) => resolve(event.target.result);
            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME);
              }
            };
          });
        }
        
        function saveToIndexedDB(key, data) {
          return openDatabase().then(db => {
            return new Promise((resolve, reject) => {
              const tx = db.transaction(STORE_NAME, 'readwrite');
              const store = tx.objectStore(STORE_NAME);
              store.put(data, key);
              tx.oncomplete = resolve;
              tx.onerror = (event) => reject(event.target.error);
            });
          });
        }
        
        function loadFromIndexedDB(key) {
          return openDatabase().then(db => {
            return new Promise((resolve, reject) => {
              const tx = db.transaction(STORE_NAME, 'readonly');
              const store = tx.objectStore(STORE_NAME);
              const request = store.get(key);
              request.onsuccess = () => resolve(request.result);
              request.onerror = (event) => reject(event.target.error);
            });
          });
        }

  
        useEffect(() => {
          if (!insights || insights.length === 0) return;
        
          const userData = insights.map(i => ({
            id: i.id,
            fav: i.fav,
            reviewed: i.reviewed,
            note: i.note
          }));
          saveToIndexedDB('userData', userData);
        }, [insights]);

        useEffect(() => {
          Promise.all([
            loadFromIndexedDB('insights'),
            loadFromIndexedDB('userData')
          ])
            .then(([storedInsights, userData]) => {
              if (!Array.isArray(storedInsights)) return;
        
              setInsightsBase(storedInsights);
        
              // Map userData by ID for fast lookup
              const userMap = new Map((userData || []).map(entry => [entry.id, entry]));
        
              // Merge userData into base insights
              const merged = storedInsights.map(insight => {
                const user = userMap.get(insight.id) || {};
                return {
                  ...insight,
                  fav: user.fav || false,
                  reviewed: user.reviewed || false,
                  note: user.note || ''
                };
              });
        
              setInsights(merged);
            })
            .catch((e) => {
              console.error("Failed to load insights or user data from IndexedDB:", e);
            });
        }, []);

          
          const headerContainerRef = useRef(null);
          const fileInputRef = useRef(null);
          
          const handleExport = () => {
            const dataStr = JSON.stringify(insights, null, 2);
            const dataBlob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = 'jazz_insights_data.json';
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
          };

        const handleLoadInsights = () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = (event) => {
            const file = event.target.files[0];
            if (!file) return;
        
            const reader = new FileReader();
            reader.onload = async (e) => {
              try {
                const data = JSON.parse(e.target.result);
        
                // Save to IndexedDB instead of localStorage
                await saveToIndexedDB('insights', data);
        
                if (!Array.isArray(data) || !data.every(insight => insight.id && insight.title && insight.call_date)) {
                  throw new Error("Invalid insights file format.");
                }
                
                setInsightsBase(data);
                setInsights(data.map(insight => ({
                  ...insight,
                  fav: false,
                  reviewed: false,
                  note: ''
                })));
                alert("Insights loaded successfully.");
              } catch (err) {
                alert("Error loading insights: " + err.message);
              }
            };
            reader.readAsText(file);
          };
          input.click();
        };
        
        const handleImportUserData = () => {
          fileInputRef.current.click();
        };


          const handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const importedData = JSON.parse(e.target.result);
                if (Array.isArray(importedData) && importedData[0].id) {
                  const originalDataMap = new Map(insightsBase.map(i => [i.id, i]));
                  const mergedInsights = importedData.map(importedInsight => ({
                    ...originalDataMap.get(importedInsight.id),
                    ...importedInsight
                  }));
                  setInsights(mergedInsights);
                  alert('Data imported successfully!');

                } else {
                  alert('Error: Invalid JSON file format.');
                }
              } catch (error) {
                console.error("Failed to parse JSON", error);
                alert('Error: Could not read the file. Please ensure it is a valid JSON file.');
              }
            };
            reader.readAsText(file);
            event.target.value = null; 
          };

          // --- NEW: Handlers for the Welcome Modal ---
          const handleWelcomeLoadData = () => {
            fileInputRef.current.click();
          };

          useEffect(() => {
            const handleScroll = () => {
              if (headerContainerRef.current) {
                setIsSticky(window.scrollY > headerContainerRef.current.offsetHeight);
              }
            };
            window.addEventListener('scroll', handleScroll);
            return () => window.removeEventListener('scroll', handleScroll);
          }, []);
                                        
          const [isFilterOverlayVisible, setIsFilterOverlayVisible] = useState(false);
                
          const monthNames = useMemo(() => ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"], []);
          
          const parsedDates = useMemo(() => {
            const dates = {};
            insightsBase.forEach(insight => {
                if(!insight.call_date) return;
                const parts = insight.call_date.split(' ');
                if(parts.length !== 3) return;
                const [day, monthName, year] = parts;
                if (!dates[year]) dates[year] = {};
                if (!dates[year][monthName]) dates[year][monthName] = [];
                if (!dates[year][monthName].includes(day)) {
                    dates[year][monthName].push(day);
                }
            });
            const sortedYears = Object.keys(dates).sort((a,b) => b-a);
            const sortedDates = {};
            sortedYears.forEach(year => {
                sortedDates[year] = dates[year];
            });
            return sortedDates;
          }, [insightsBase]);

          const uniqueYears = useMemo(() => Object.keys(parsedDates), [parsedDates]);
          const availableMonths = useMemo(() => selectedYear ? Object.keys(parsedDates[selectedYear] || {}).sort((a,b) => monthNames.indexOf(a) - monthNames.indexOf(b)) : [], [selectedYear, parsedDates, monthNames]);
          const availableDays = useMemo(() => (selectedYear && selectedMonth && parsedDates[selectedYear]?.[selectedMonth]) ? parsedDates[selectedYear][selectedMonth].sort((a,b) => a-b) : [], [selectedYear, selectedMonth, parsedDates]);

          const filteredInsights = useMemo(() => {
            let results = [...insights];

            if (searchTerm) {
              const lowercasedTerm = searchTerm.toLowerCase();
              results = results.filter(insight =>
                Object.values(insight).some(val => 
                    String(val).toLowerCase().includes(lowercasedTerm)
                )
              );
            }
            if (selectedTags.length > 0) {
              results = results.filter(insight =>
                selectedTags.every(tag => (insight.tags || []).includes(tag))
              );
            }
            if (selectedCoaches.length > 0) {
              results = results.filter(insight => selectedCoaches.includes(insight.coach));
            }
            if(selectedYear) results = results.filter(i => i.call_date.endsWith(selectedYear));
            if(selectedMonth) results = results.filter(i => i.call_date.includes(` ${selectedMonth} `));
            if(selectedDay) results = results.filter(i => i.call_date.startsWith(`${selectedDay} `));
            
            if (favOnly) results = results.filter(i => i.fav);
            if (reviewedOnly) results = results.filter(i => i.reviewed);
            if (hasNoteOnly) results = results.filter(i => i.note && i.note.trim() !== '');
			
            switch (sortOrder) {
              case 'date-desc':
                results.sort((a, b) => new Date(b.call_date) - new Date(a.call_date));
                break;
              case 'date-asc':
                results.sort((a, b) => new Date(a.call_date) - new Date(b.call_date));
                break;
              case 'alpha':
                results.sort((a, b) => a.title.localeCompare(b.title));
                break;
              case 'random':
                for (let i = results.length - 1; i > 0; i--) {
                  const j = Math.floor(Math.random() * (i + 1));
                  [results[i], results[j]] = [results[j], results[i]];
                }
                break;
              default:
                break;
            }

            return results;
          }, [insights, searchTerm, selectedTags, selectedCoaches, selectedYear, selectedMonth, selectedDay, favOnly, reviewedOnly, hasNoteOnly, sortOrder]);       

          useEffect(() => {
            setVisibleCount(ITEMS_PER_PAGE);
          }, [filteredInsights]);

          const insightsToDisplay = useMemo(() => {
            return filteredInsights.slice(0, visibleCount);
          }, [filteredInsights, visibleCount]);          

          const clearAllFilters = () => {
              setSelectedTags([]);
              setSelectedCoaches([]);
              setSelectedYear('');
              setSelectedMonth('');
              setSelectedDay('');
              setSearchTerm('');
			        setFavOnly(false);
              setReviewedOnly(false);
              setHasNoteOnly(false);
          };
          
  		    const hasActiveFilters =
		        selectedTags.length > 0 || selectedCoaches.length > 0 ||
		        selectedYear || favOnly || reviewedOnly || hasNoteOnly || searchTerm;

            const updateInsight = (id, updateFn) => {
              setInsights(currentInsights => {
                const updated = currentInsights.map(insight =>
                  insight.id === id ? updateFn(insight) : insight
                );
            
                // Save user data subset to IndexedDB
                const userData = updated.map(i => ({
                  id: i.id,
                  fav: i.fav,
                  reviewed: i.reviewed,
                  note: i.note
                }));
                saveToIndexedDB('userData', userData);
            
                return updated;
              });
            };


          const handleToggleFav = (id) => {
            updateInsight(id, insight => ({ ...insight, fav: !insight.fav }));
          };

          const handleToggleReviewed = (id) => {
            updateInsight(id, insight => ({ ...insight, reviewed: !insight.reviewed }));
          };
          
          const handleSaveNote = (id, noteText) => {
            updateInsight(id, insight => ({ ...insight, note: noteText }));
          };

          const handleDeleteNote = (id) => {
            updateInsight(id, insight => ({ ...insight, note: '' }));
          };

          const filterControlProps = {
            searchTerm,
            onSearchTermChange: setSearchTerm,
            sortOrder,
            onSortOrderChange: setSortOrder,
            coaches: allCoaches,
            selectedCoaches,
            onSelectCoach: (coach) => setSelectedCoaches(prev => prev.includes(coach) ? prev.filter(c => c !== coach) : [...prev, coach]),
            years: uniqueYears,
            selectedYear,
            onSelectYear: (year) => { setSelectedYear(year); setSelectedMonth(''); setSelectedDay(''); },
            months: availableMonths,
            selectedMonth,
            onSelectMonth: (month) => { setSelectedMonth(month); setSelectedDay(''); },
            days: availableDays,
            selectedDay,
            onSelectDay: (day) => setSelectedDay(day),
            tags: allTags,
            selectedTags,
            onSelectTag: (tag) => setSelectedTags(prev => prev.includes(tag) ? prev.filter(t => t !== tag) : [...prev, tag]),
            tagsExpanded,
            onToggleTags: () => setTagsExpanded(!tagsExpanded),
            favOnly,
            onToggleFav: () => setFavOnly(!favOnly),
            reviewedOnly,
            onToggleReviewed: () => setReviewedOnly(!reviewedOnly),
            hasNoteOnly,
            onToggleHasNote: () => setHasNoteOnly(!hasNoteOnly),
            hasActiveFilters,
            onClearAll: clearAllFilters
          };

return (
            <>
                          
              <div className="bg-parchment min-h-screen text-brand-dark">
                
                <StickyHeader 
                  isSticky={isSticky}
                  onShowFilters={() => setIsFilterOverlayVisible(true)}
                  visibleCount={insightsToDisplay.length}
                  totalCount={filteredInsights.length}
                />
                <FilterOverlay 
                  isVisible={isFilterOverlayVisible} 
                  onClose={() => setIsFilterOverlayVisible(false)}
                >
                  <FilterControls {...filterControlProps} />
                </FilterOverlay>

                <div className="container mx-auto px-4 py-8 md:py-12">
                  
                  <div ref={headerContainerRef}>
                    <header className="text-center mb-12">
                      <div className="flex justify-center items-center mb-4 gap-4">
                        <h1 className="text-4xl md:text-5xl lg:text-6xl font-serif font-bold text-brand-dark">Insights from the Jazz Intensive</h1>
                      </div>
                      <p className="text-base md:text-lg text-gray-600 max-w-3xl mx-auto">An interactive library of teaching moments from Nick Mainella and Chris Klaxton.</p>
                      
                    <div className="mt-6 flex justify-center gap-3">
                      <button
                        onClick={handleLoadInsights}
                        className="bg-blue-500 text-white font-semibold py-2 px-5 rounded-full hover:bg-blue-600 transition-colors"
                      >
                        Load Insights
                      </button>
                    
                      <button
                        onClick={handleImportUserData}
                        className="bg-green-500 text-white font-semibold py-2 px-5 rounded-full hover:bg-green-600 transition-colors"
                      >
                        Load User Data
                      </button>
                    
                      <button
                        onClick={handleExport}
                        className="bg-yellow-400 text-black font-semibold py-2 px-5 rounded-full hover:bg-yellow-500 transition-colors"
                      >
                        Export User Data
                      </button>
                    </div>

                    </header>

                    <div className="max-w-4xl mx-auto space-y-6 mb-8">
                      <div className="bg-parchment/90 backdrop-blur-lg z-10 py-6 rounded-lg">
                          <FilterControls {...filterControlProps} />
                      </div>
                    </div>
                  </div>
                  
                  <main>
                    {filteredInsights.length > 0 && (
                      <div className="text-center mb-6 text-gray-600 font-semibold">
                        Displaying {insightsToDisplay.length} of {filteredInsights.length} insights.
                      </div>
                    )}

                    {insightsToDisplay.length > 0 ? (
                      <div className="grid gap-8 md:grid-cols-1 lg:grid-cols-2">
                          {insightsToDisplay.map(insight => (
                            <InsightCard 
                              key={insight.id} 
                              insight={insight}
                              onToggleFav={() => handleToggleFav(insight.id)}
                              onToggleReviewed={() => handleToggleReviewed(insight.id)}
                              onSaveNote={handleSaveNote}
                              onDeleteNote={handleDeleteNote}
                            />
                          ))}
                        </div>
                    ) : (
                      <div className="text-center py-16 px-6 bg-white rounded-lg border border-gray-200">
                          <h3 className="text-2xl font-bold text-brand-dark">No Insights Found</h3>
                          <p className="text-gray-600 mt-2">Try adjusting your search or filters.</p>
                      </div>
                    )}

                    {visibleCount < filteredInsights.length && (
                      <div className="text-center mt-12">
                        <button
                          onClick={() => setVisibleCount(prev => prev + ITEMS_PER_PAGE)}
                          className="bg-brand-dark text-white font-bold py-3 px-8 rounded-full hover:bg-opacity-80 transition-all"
                        >
                          Load More Insights
                        </button>
                      </div>
                    )}
                  </main>
                  
                  <footer className="text-center mt-16 text-gray-500 text-sm">
                      <p>Created from the teachings of Nick Mainella & Chris Klaxton. All insights copyright of their original creator.</p>
                  </footer>
                </div>
              </div>
            </>
          );
        }
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
	<script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js");
      }
    </script>

</body>
</html>
